---
Chapter: Apache Airflow 살펴보기
---
## 데이터 파이프라인
> 파이프라인은 원하는 결과를 얻기 위해 서로 다른 태스크로 구성

### 특징
1. 각 태스크는 순서와 그에 해당하는 의미가 있기 때문에 정해진 순서대로 진행되어야 한다.
2. **방향성 비순환 그래프(Directed Acyclic Graph, DAG)**라고 표현한다.
	1. 태스크를 노드로 태스크간의 순서(의존성)은 방향성이 있는 선으로 표현
	2. 반복이나 순환이 되면 교착상태로 이어지기 때문에 **반복이나 순환을 허용하지 않는다.**

### 파이프라인 그래프 실행
1. 다음 태스크를 실행하기 전에 이전 태스크가 완료되었는지 확인
	- 이전 태스크가 완료된 상태라면 다음 실행할 태스크를 큐에 추가
2. 큐에 있는 태스크를 실행하고, 수행이 완료되면 완료 표시
3. 그래프의 모든 태스크가 완료될 때까지 1 ~ 2를 반복
![[파이프라인 실행 과정.png|500]]

### DAG로 파이프라인을 구성하는 이유
1. 의존성에 따라 동시에 실행할 수 있는 태스크는 병렬로 실행하여 실행 시간을 줄일 수 있다.
2. 파이프라인 실행중에 태스크 실패시, 전체 태스크를 다시 실행하는 것이 아닌 실패한 시점부터 파이프라인을 재실행하면 되므로 효율적이다.

### 파이프라인 실행을 위한 워크플로 도구

| 이름    | 워크플로 정의 | 태스크 개발 언어 | 스케쥴 관리 가능 여부 | 백필 지원 여부 | UI 지원 여부 | 설치 플랫폼 | 수평확장 가능 여부 |
| --------- | ----------- | ------------- | ---------------- | ------------ | ------------ | ---------- | -------------- |
| Airflow   | python      | python        | Y                | Y            | Y            | Anywhere   | Y              |
| Argo      | YAML        | go            | Y(3rd party)     | -            | Y            | Kubernetes | Y              |
| Azkaban   | YAML        | java          | Y                | N            | Y            | Anywhere   | -              |
| Conductor | JSON        | java          | N                | -            | Y            | Anywhere   | Y              |
| Luigi     | python      | python        | N                | Y            | Y            | Anywhere   | Y              |
| Make      | Custom DSL  | C             | N                | N            | N            | Anywhere   | N              |
| Metaflow  | python      | python        | N                | -            | N            | Anywhere   | Y              |
| Nifi      | UI          | java          | Y                | N            | Y            | Anywhere   | Y              |
| Oozie     | XML         | java          | Y                | Y            | Y            | Hadoop     | Y              |

## Airflow
> 파이프라인이나 워크플로 태스크를 DAG로 정의하고 모니터링하기 위한 오케스트레이션 도구


### 특징
1. 데이터베이스, 클라우드 서비스 및 빅데이터 기술을 태스크에서 실행할 수 있도록 확장 기능이 계속 개발되고 있다.
2. Cron 같은 표현식으로 복잡한 스케쥴을 지정할 수 있다.

### 주요 구성 요소
- **스케쥴러**: DAG를 분석하고 현재 시점에서 DAG의 스케쥴이 지난 경우, 워커에 DAG의 태스크를 예약
- **워커**: 예약된 태스크를 선택하고 실행
- **웹 서버**: 스케쥴러에서 분석한 DAG를 시각화하고 DAG 실행과 결과를 확인할 수 있는 주요 인터페이스 제공
#### 스케쥴러 실행 순서
1. DAG를 작성하면, 스케쥴러는 DAG를 분석하고 각 DAG 태스크, 의존성 및 예약 주기를 확인
2. DAG의 예약 주기가 경과했는지 확인
	- 예약 주기가 현재 시간 이전이라면 실행되도록 에약
3. 예약된 각 태스크에 대해 스케쥴러는 해당 태스크의 의존성을 확인
	- 업스트림 태스크가 실행되지 않았을 경우, 업스트림 태스크를 실행 대기열에 추가
	- 업스트림 태스크가 실행 완료된 경우, 그 다운스트림 태스크를 실행 대기열에 추가
4. 1단계로 돌아간 후, 새로운 루프를 잠시 동안 대기
![[Airflow DAG 실행 과정.png|500]]
#### 웹 서버
- DAG에 대한 의존성 확인, 최근실행 결과 및 요약 등 다양한 내용을 웹 인터페이스를 통해 확인할 수 있다.

### 점진적 로딩 및 백필
- **점진적인 데이터 파이프라인**: 특정 시간에 대한 데이터 세트만 처리하는 데이터 파이프라인. 전체 데이터 세트를 다시 처리하지 않기 때문에 대규모 데이터 세트 처리시 시간과 비용을 줄일 수 있다.
- **백필(Backfill)**: 특정 과거 시점 및 기간의 데이터 세트에 대해 DAG를 재실행하는 것. 특정 기간의 데이터에 대한 새로운 결과를 얻거나 결과를 복원할 수 있다.

### Airflow를 사용해야 하는 이유
1. 파이썬 코드로 파이프라인을 구현하기 때문에 파이썬을 통한 복잡한 커스텀 파이프라인을 만들 수 있다.
2. 다양한 데이터베이스, 클라우드 서비스 등과 통합할 수 있는 기능을 제공
3. 백필을 통해 재생성이 필요한 데이터 재처리가 가능
4. 웹 서버를 통해 파이프라인 실행 결과를 모니터링할 수 있다.
5. 오픈 소스이기 때문에 특정 벤더에 종속되지 않고 환경을 구축할 수 있다.

### Airflow의 단점
1. 배치 테스크를 실행하는 것에 초점이 맞춰져 있기 때문에, 스트리밍 태스크를 실행하는 것에는 적합하지 않다.
2. DAG가 많아지면 복잡해지기 때문에 초기 시점부터 엄격환 관리가 필요하다.
3. 데이터 리니지, 데이터 버전 관리 같은 기능들은 제공하지 않기 때문에 필요에 따라 다른 도구와 통합해야 한다.
